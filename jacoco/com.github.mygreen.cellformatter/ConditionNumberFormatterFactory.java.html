<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ja"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ConditionNumberFormatterFactory.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Excel-CellFormatter</a> &gt; <a href="index.source.html" class="el_package">com.github.mygreen.cellformatter</a> &gt; <span class="el_source">ConditionNumberFormatterFactory.java</span></div><h1>ConditionNumberFormatterFactory.java</h1><pre class="source lang-java linenums">package com.github.mygreen.cellformatter;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.github.mygreen.cellformatter.lang.ArgUtils;
import com.github.mygreen.cellformatter.lang.Utils;
import com.github.mygreen.cellformatter.number.FormattedNumber;
import com.github.mygreen.cellformatter.number.NumberFactory;
import com.github.mygreen.cellformatter.number.NumberPartType;
import com.github.mygreen.cellformatter.term.AsteriskTerm;
import com.github.mygreen.cellformatter.term.EscapedCharTerm;
import com.github.mygreen.cellformatter.term.LocaelSymbolTerm;
import com.github.mygreen.cellformatter.term.NumberTerm;
import com.github.mygreen.cellformatter.term.OtherTerm;
import com.github.mygreen.cellformatter.term.Term;
import com.github.mygreen.cellformatter.term.UnderscoreTerm;
import com.github.mygreen.cellformatter.term.WordTerm;
import com.github.mygreen.cellformatter.tokenizer.Token;
import com.github.mygreen.cellformatter.tokenizer.TokenStore;


/**
 * {@link ConditionNumberFormatter}のインスタンスを作成するクラス。
 *
 * @version 0.10
 * @author T.TSUCHIE
 *
 */
<span class="fc" id="L34">public class ConditionNumberFormatterFactory extends ConditionFormatterFactory&lt;ConditionNumberFormatter&gt; {</span>

<span class="fc" id="L36">    private static final Logger logger = LoggerFactory.getLogger(ConditionNumberFormatterFactory.class);</span>

<span class="fc" id="L38">    private static final String[] FORMAT_CHARS = {</span>
        &quot;#&quot;, &quot;0&quot;, &quot;?&quot;,
    };

<span class="fc" id="L42">    public static final String[] SYMBOL_CHARS = {</span>
        &quot;.&quot;, &quot;,&quot;,
        &quot;%&quot;, &quot;/&quot;,
    };

<span class="fc" id="L47">    public static final String[] OTHER_CHARS = {</span>
        &quot;E+&quot;, &quot;E-&quot;,
        &quot;General&quot;,
    };

<span class="fc" id="L52">    public static final String[] DIGITS_START_CHARS = {</span>
        &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;, &quot;6&quot;, &quot;7&quot;, &quot;8&quot;, &quot;9&quot;,
    };

<span class="fc" id="L56">    public static final String[] DIGITS_CHARS = {</span>
        &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;, &quot;6&quot;, &quot;7&quot;, &quot;8&quot;, &quot;9&quot;, &quot;0&quot;,
    };

    /**
     * 数値の書式かどうかを決定するためのキーワード。
     */
<span class="fc" id="L63">    private static final String[] NUMBER_DECISTION_CHARS = toArray(</span>
            FORMAT_CHARS,
            SYMBOL_CHARS
    );

    /**
     * 数値の項としてのキーワード
     */
<span class="fc" id="L71">    private static final String[] NUMBER_TERM_CHARS = toArray(</span>
            FORMAT_CHARS,
            SYMBOL_CHARS,
            OTHER_CHARS,
            DIGITS_START_CHARS
    );

    /**
     * {@link #NUMBER_TERM_CHARS}を、検索用に並び替えたもの。
     * ・フォーマットのキーワードを①文字列の長い順、辞書順に並び変え、比較していく。
     */
<span class="fc" id="L82">    private static final List&lt;String&gt; SORTED_NUMBER_TERM_CHARS = Utils.reverse(NUMBER_TERM_CHARS);</span>

    /**
     * 数値の書式かどうか判定する。
     * @param store
     * @return
     */
    public boolean isNumberPattern(final TokenStore store) {
<span class="fc" id="L90">        return store.containsAnyInFactor(NUMBER_DECISTION_CHARS);</span>
    }

    @Override
    public ConditionNumberFormatter create(final TokenStore store) {
<span class="fc" id="L95">        ArgUtils.notNull(store, &quot;store&quot;);</span>

<span class="fc" id="L97">        final ConditionNumberFormatter formatter = new ConditionNumberFormatter(store.getConcatenatedToken());</span>

<span class="fc bfc" id="L99" title="All 2 branches covered.">        for(Token token : store.getTokens()) {</span>

<span class="fc bfc" id="L101" title="All 2 branches covered.">            if(token instanceof Token.Condition) {</span>
                // 条件の場合
<span class="fc" id="L103">                final Token.Condition conditionToken = token.asCondition();</span>
<span class="fc" id="L104">                final String condition = conditionToken.getCondition();</span>
<span class="fc" id="L105">                formatter.addCondition(condition);</span>

<span class="fc bfc" id="L107" title="All 2 branches covered.">                if(isConditionOperator(conditionToken)) {</span>
<span class="fc" id="L108">                    setupConditionOperator(formatter, conditionToken);</span>

<span class="fc bfc" id="L110" title="All 2 branches covered.">                } else if(isConditionLocale(conditionToken)) {</span>
<span class="fc" id="L111">                    setupConditionLocale(formatter, conditionToken);</span>

<span class="fc bfc" id="L113" title="All 2 branches covered.">                } else if(isConditionLocaleSymbol(conditionToken)) {</span>
<span class="fc" id="L114">                    final LocaleSymbol localeSymbol = setupConditionLocaleSymbol(formatter, conditionToken);</span>
<span class="fc" id="L115">                    formatter.addTerm(new LocaelSymbolTerm&lt;FormattedNumber&gt;(localeSymbol));</span>

<span class="fc bfc" id="L117" title="All 2 branches covered.">                } else if(isConditionDbNum(conditionToken)) {</span>
<span class="fc" id="L118">                    setupConditionDbNum(formatter, conditionToken);</span>

<span class="pc bpc" id="L120" title="1 of 2 branches missed.">                } else if(isConditionColor(conditionToken)) {</span>
<span class="fc" id="L121">                    setupConditionColor(formatter, conditionToken);</span>

                }

<span class="fc bfc" id="L125" title="All 2 branches covered.">            } else if(token instanceof Token.Word) {</span>
<span class="fc" id="L126">                formatter.addTerm(new WordTerm&lt;FormattedNumber&gt;(token.asWord()));</span>

<span class="fc bfc" id="L128" title="All 2 branches covered.">            } else if(token instanceof Token.EscapedChar) {</span>
<span class="fc" id="L129">                formatter.addTerm(new EscapedCharTerm&lt;FormattedNumber&gt;(token.asEscapedChar()));</span>

<span class="fc bfc" id="L131" title="All 2 branches covered.">            } else if(token instanceof Token.Underscore) {</span>
<span class="fc" id="L132">                formatter.addTerm(new UnderscoreTerm&lt;FormattedNumber&gt;(token.asUnderscore()));</span>

<span class="fc bfc" id="L134" title="All 2 branches covered.">            } else if(token instanceof Token.Asterisk) {</span>
<span class="fc" id="L135">                formatter.addTerm(new AsteriskTerm&lt;FormattedNumber&gt;(token.asAsterisk()));</span>

<span class="pc bpc" id="L137" title="1 of 2 branches missed.">            } else if(token instanceof Token.Factor) {</span>
                // 因子を数値の書式に分解する
<span class="fc" id="L139">                final List&lt;Token&gt; list = convertFactor(token.asFactor());</span>
<span class="fc bfc" id="L140" title="All 2 branches covered.">                for(Token item : list) {</span>

<span class="fc bfc" id="L142" title="All 2 branches covered.">                    if(item instanceof Token.Formatter) {</span>
<span class="fc bfc" id="L143" title="All 2 branches covered.">                        if(item.getValue().equals(&quot;#&quot;)) {</span>
<span class="fc" id="L144">                            formatter.addTerm(NumberTerm.sharp());</span>

<span class="fc bfc" id="L146" title="All 2 branches covered.">                        } else if(item.getValue().equals(&quot;0&quot;)) {</span>
<span class="fc" id="L147">                            formatter.addTerm(NumberTerm.zero());</span>

<span class="pc bpc" id="L149" title="1 of 2 branches missed.">                        } else if(item.getValue().equals(&quot;?&quot;)) {</span>
<span class="fc" id="L150">                            formatter.addTerm(NumberTerm.question());</span>

                        } else {
<span class="nc" id="L153">                            logger.warn(&quot;unknown formatter : '{}'&quot;, item.getValue());</span>
                        }

<span class="fc bfc" id="L156" title="All 2 branches covered.">                    } else if(item instanceof Token.Factor) {</span>
<span class="fc bfc" id="L157" title="All 2 branches covered.">                        if(Utils.startsWithIgnoreCase(item.getValue(), &quot;E&quot;)) {</span>
<span class="fc" id="L158">                            formatter.addTerm(NumberTerm.exponnet(item));</span>

<span class="fc bfc" id="L160" title="All 2 branches covered.">                        } else if(item.getValue().equals(&quot;General&quot;)) {</span>
<span class="fc" id="L161">                            formatter.addTerm(NumberTerm.general());</span>

                        } else {
<span class="fc" id="L164">                            formatter.addTerm(new OtherTerm&lt;FormattedNumber&gt;(item));</span>

                        }

<span class="fc bfc" id="L168" title="All 2 branches covered.">                    } else if(item instanceof Token.Symbol) {</span>
<span class="fc bfc" id="L169" title="All 2 branches covered.">                        if(item == Token.SYMBOL_COLON) {</span>
<span class="fc" id="L170">                            formatter.addTerm(NumberTerm.separator(item.asSymbol()));</span>

                        } else {
<span class="fc" id="L173">                            formatter.addTerm(NumberTerm.symbol(item.asSymbol()));</span>
                        }

<span class="pc bpc" id="L176" title="1 of 2 branches missed.">                    } else if(item instanceof Token.Digits) {</span>
<span class="fc" id="L177">                        formatter.addTerm(NumberTerm.digits(item.asDigits()));</span>

                    } else {
<span class="nc" id="L180">                        formatter.addTerm(new OtherTerm&lt;FormattedNumber&gt;(item));</span>
                    }

<span class="fc" id="L183">                }</span>

<span class="fc" id="L185">            } else {</span>
<span class="nc" id="L186">                formatter.addTerm(new OtherTerm&lt;FormattedNumber&gt;(token));</span>
            }
<span class="fc" id="L188">        }</span>

        // 書式に付加情報を設定する
<span class="fc" id="L191">        setupFormat(formatter);</span>

<span class="fc" id="L193">        return formatter;</span>
    }

    private List&lt;Token&gt; convertFactor(final Token.Factor factor) {

<span class="fc" id="L198">        final String item = factor.getValue();</span>
<span class="fc" id="L199">        final int itemLength = item.length();</span>

<span class="fc" id="L201">        final List&lt;Token&gt; list = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L203">        int idx = 0;</span>
        // フォーマット以外の文字列を積む
<span class="fc" id="L205">        StringBuilder noTermChar = new StringBuilder();</span>

<span class="fc bfc" id="L207" title="All 2 branches covered.">        while(idx &lt; itemLength) {</span>

<span class="fc" id="L209">            String matchChars = null;</span>
<span class="fc bfc" id="L210" title="All 2 branches covered.">            for(String chars : SORTED_NUMBER_TERM_CHARS) {</span>
<span class="fc bfc" id="L211" title="All 2 branches covered.">                if(Utils.startsWithIgnoreCase(item, chars, idx)) {</span>
<span class="fc" id="L212">                    matchChars = item.substring(idx, idx + chars.length());</span>
<span class="fc" id="L213">                    break;</span>
                }
<span class="fc" id="L215">            }</span>

<span class="fc bfc" id="L217" title="All 2 branches covered.">            if(matchChars == null) {</span>
                // フォーマット出ない場合は、文字列としてバッファに追加する。
<span class="fc" id="L219">                noTermChar.append(item.charAt(idx));</span>
<span class="fc" id="L220">                idx++;</span>

            } else {
                // 数値の書式の場合

<span class="fc bfc" id="L225" title="All 2 branches covered.">                if(noTermChar.length() &gt; 0) {</span>
                    // 今まで積んだバッファを、文字列として分割する。
<span class="fc" id="L227">                    list.add(Token.factor(noTermChar.toString()));</span>
<span class="fc" id="L228">                    noTermChar = new StringBuilder();</span>
                }

<span class="fc bfc" id="L231" title="All 2 branches covered.">                if(Utils.equalsAny(matchChars, DIGITS_START_CHARS)) {</span>
                    // 数字として切り出す。
<span class="fc" id="L233">                    StringBuilder digits = new StringBuilder();</span>
<span class="fc" id="L234">                    digits.append(matchChars);</span>

<span class="fc bfc" id="L236" title="All 2 branches covered.">                    for(int i=idx+1; i &lt; itemLength; i++) {</span>
<span class="fc" id="L237">                        final String str = String.valueOf(item.charAt(i));</span>
<span class="pc bpc" id="L238" title="1 of 2 branches missed.">                        if(Utils.equalsAny(str, DIGITS_CHARS)) {</span>
<span class="fc" id="L239">                            digits.append(str);</span>
                        } else {
                            break;
                        }
                    }

<span class="fc" id="L245">                    list.add(Token.digits(digits.toString()));</span>
<span class="fc" id="L246">                    idx += digits.length();</span>

<span class="fc" id="L248">                } else {</span>
<span class="fc bfc" id="L249" title="All 2 branches covered.">                    if(Utils.equalsAny(matchChars, FORMAT_CHARS)) {</span>
<span class="fc" id="L250">                        list.add(Token.formatter(matchChars));</span>

<span class="fc bfc" id="L252" title="All 2 branches covered.">                    } else if(Utils.equalsAny(matchChars, SYMBOL_CHARS)) {</span>
<span class="fc bfc" id="L253" title="All 2 branches covered.">                        if(matchChars.equals(&quot;.&quot;)) {</span>
<span class="fc" id="L254">                            list.add(Token.SYMBOL_DOT);</span>

<span class="fc bfc" id="L256" title="All 2 branches covered.">                        } else if(matchChars.equals(&quot;,&quot;)) {</span>
<span class="fc" id="L257">                            list.add(Token.SYMBOL_COLON);</span>

<span class="fc bfc" id="L259" title="All 2 branches covered.">                        } else if(matchChars.equals(&quot;%&quot;)) {</span>
<span class="fc" id="L260">                            list.add(Token.SYMBOL_PERCENT);</span>

<span class="pc bpc" id="L262" title="1 of 2 branches missed.">                        } else if(matchChars.equals(&quot;/&quot;)) {</span>
<span class="fc" id="L263">                            list.add(Token.SYMBOL_SLASH);</span>

                        } else {
<span class="nc" id="L266">                            logger.warn(&quot;unknown symbol : '{}'&quot;, matchChars);</span>
                        }

                    } else {
<span class="fc" id="L270">                        list.add(Token.factor(matchChars));</span>
                    }

<span class="fc" id="L273">                    idx += matchChars.length();</span>

                }

            }

<span class="fc" id="L279">        }</span>

<span class="fc bfc" id="L281" title="All 2 branches covered.">        if(noTermChar.length() &gt; 0) {</span>
<span class="fc" id="L282">            list.add(Token.factor(noTermChar.toString()));</span>
        }

<span class="fc" id="L285">        return list;</span>

    }

    /**
     * 構築した項に対してインデックス番号などを付与する。
     * @param formatter
     */
    private void setupFormat(final ConditionNumberFormatter formatter) {

<span class="fc bfc" id="L295" title="All 2 branches covered.">        if(formatter.containsSymbolTerm(Token.SYMBOL_SLASH)) {</span>
            // 分数として処理する
<span class="fc" id="L297">            setupFormatAsFraction(formatter);</span>
        } else {
            // 数値として処理する
<span class="fc" id="L300">            setupFormatAsDecimal(formatter);</span>
        }

<span class="fc" id="L303">    }</span>

    private void setupFormatAsFraction(final ConditionNumberFormatter formatter) {

<span class="fc" id="L307">        final int termSize = formatter.getTerms().size();</span>

        // 分数の区切り記号の位置
<span class="fc" id="L310">        int slashIndex = -1;</span>
<span class="pc bpc" id="L311" title="1 of 2 branches missed.">        for(int i=0; i &lt; termSize; i++) {</span>

<span class="fc" id="L313">            final Term&lt;FormattedNumber&gt; term = formatter.getTerms().get(i);</span>
<span class="fc bfc" id="L314" title="All 2 branches covered.">            if(isSymbolTerm(term, Token.SYMBOL_SLASH)) {</span>
<span class="fc" id="L315">                slashIndex = i;</span>
<span class="fc" id="L316">                break;</span>
            }

        }

        // 分子、帯分数の情報の設定
<span class="fc" id="L322">        boolean wholeType = false;</span>
<span class="pc bpc" id="L323" title="1 of 2 branches missed.">        if(slashIndex &gt; 0) {</span>
<span class="fc" id="L324">            NumberPartType partType = NumberPartType.Numerator;</span>
<span class="fc" id="L325">            int countNumeratorTerm = 0;</span>
<span class="fc" id="L326">            int countWholeNumberTerm = 0;</span>
<span class="fc" id="L327">            boolean foundFirst = false;</span>

<span class="fc bfc" id="L329" title="All 2 branches covered.">            for(int i=slashIndex-1; i &gt;= 0; i--) {</span>
<span class="fc" id="L330">                final Term&lt;FormattedNumber&gt; term = formatter.getTerms().get(i);</span>

<span class="fc bfc" id="L332" title="All 2 branches covered.">                if(term instanceof NumberTerm.FormattedTerm) {</span>
<span class="fc" id="L333">                    final NumberTerm.FormattedTerm formattedTerm = (NumberTerm.FormattedTerm) term;</span>
<span class="fc" id="L334">                    formattedTerm.setPart(partType);</span>

<span class="fc bfc" id="L336" title="All 2 branches covered.">                    if(partType.equals(NumberPartType.Numerator)) {</span>
<span class="fc" id="L337">                        countNumeratorTerm++;</span>
<span class="fc" id="L338">                        formattedTerm.setIndex(countNumeratorTerm);</span>

<span class="pc bpc" id="L340" title="1 of 2 branches missed.">                    } else if(partType.equals(NumberPartType.WholeNumber)) {</span>
<span class="fc" id="L341">                        countWholeNumberTerm++;</span>
<span class="fc" id="L342">                        formattedTerm.setIndex(countWholeNumberTerm);</span>
                    }

<span class="fc bfc" id="L345" title="All 2 branches covered.">                    if(!foundFirst) {</span>
<span class="fc" id="L346">                        foundFirst = true;</span>
                    }

<span class="fc" id="L349">                } else {</span>
                    // 連続する書式の間に他の文字が入る場合は、帯分数として処理する。
<span class="pc bpc" id="L351" title="1 of 2 branches missed.">                    if(foundFirst) {</span>
<span class="fc" id="L352">                        partType = NumberPartType.WholeNumber;</span>
                    }
                }

            }

<span class="fc bfc" id="L358" title="All 2 branches covered.">            if(countWholeNumberTerm &gt; 0) {</span>
                // 帯分数かどうか
<span class="fc" id="L360">                wholeType = true;</span>
            }
        }

        // 分母の処理
<span class="fc" id="L365">        boolean exactDenom=false;</span>
<span class="fc" id="L366">        int denominator = -1;</span>
<span class="pc bpc" id="L367" title="1 of 2 branches missed.">        if(slashIndex &lt; termSize) {</span>
<span class="fc" id="L368">            int countDenominatorTerm = 0;</span>
<span class="fc" id="L369">            int exactDenominator = -1;</span>
<span class="fc bfc" id="L370" title="All 2 branches covered.">            for(int i=termSize-1; i &gt; slashIndex; i--) {</span>

<span class="fc" id="L372">                final Term&lt;FormattedNumber&gt; term = formatter.getTerms().get(i);</span>
<span class="fc bfc" id="L373" title="All 2 branches covered.">                if(term instanceof NumberTerm.FormattedTerm) {</span>
<span class="fc" id="L374">                    final NumberTerm.FormattedTerm formattedTerm = (NumberTerm.FormattedTerm) term;</span>
<span class="fc" id="L375">                    formattedTerm.setPart(NumberPartType.Denominator);</span>

<span class="fc" id="L377">                    countDenominatorTerm++;</span>
<span class="fc" id="L378">                    formattedTerm.setIndex(countDenominatorTerm);</span>

<span class="pc bpc" id="L380" title="1 of 2 branches missed.">                } else if(term instanceof NumberTerm.DigitsTerm) {</span>
<span class="fc" id="L381">                    final NumberTerm.DigitsTerm digitsTerm = (NumberTerm.DigitsTerm) term;</span>
<span class="fc" id="L382">                    exactDenominator = digitsTerm.getToken().intValue();</span>

                }
            }

<span class="fc bfc" id="L387" title="All 2 branches covered.">            if(exactDenominator &gt; 0) {</span>
<span class="fc" id="L388">                denominator = exactDenominator;</span>
<span class="fc" id="L389">                exactDenom = true;</span>

<span class="pc bpc" id="L391" title="1 of 2 branches missed.">            } else if(countDenominatorTerm &gt; 0) {</span>
<span class="pc bpc" id="L392" title="1 of 2 branches missed.">                if(countDenominatorTerm &gt;= 5) {</span>
                    // 5桁以上は対応していない
<span class="nc" id="L394">                    denominator = (int) Math.pow(10, 5);</span>
                } else {
<span class="fc" id="L396">                    denominator = (int) Math.pow(10, countDenominatorTerm);</span>
                }
            } else {
<span class="nc" id="L399">                denominator = 10;</span>
            }
        }

        // 最後の項かどうかのフラグを設定する
<span class="fc" id="L404">        boolean foundFistWholeNumber = false;</span>
<span class="fc" id="L405">        boolean foundFistNumerator = false;</span>
<span class="fc" id="L406">        boolean foundFistDenominator = false;</span>
<span class="fc bfc" id="L407" title="All 2 branches covered.">        for(Term&lt;FormattedNumber&gt; term : formatter.getTerms()) {</span>

<span class="fc bfc" id="L409" title="All 2 branches covered.">            if(term instanceof NumberTerm.FormattedTerm) {</span>
<span class="fc" id="L410">                final NumberTerm.FormattedTerm formattedTerm = (NumberTerm.FormattedTerm) term;</span>

<span class="fc bfc" id="L412" title="All 4 branches covered.">                if(formattedTerm.getPartType().equals(NumberPartType.WholeNumber) &amp;&amp; !foundFistWholeNumber) {</span>
<span class="fc" id="L413">                    formattedTerm.setLastPart(true);</span>
<span class="fc" id="L414">                    foundFistWholeNumber = true;</span>

<span class="fc bfc" id="L416" title="All 4 branches covered.">                } else if(formattedTerm.getPartType().equals(NumberPartType.Numerator) &amp;&amp; !foundFistNumerator) {</span>
<span class="fc" id="L417">                    formattedTerm.setLastPart(true);</span>
<span class="fc" id="L418">                    foundFistNumerator = true;</span>

<span class="fc bfc" id="L420" title="All 4 branches covered.">                } else if(formattedTerm.getPartType().equals(NumberPartType.Denominator) &amp;&amp; !foundFistDenominator) {</span>
<span class="fc" id="L421">                    formattedTerm.setLastPart(true);</span>
<span class="fc" id="L422">                    foundFistDenominator = true;</span>
                }

            }
<span class="fc" id="L426">        }</span>

<span class="fc" id="L428">        formatter.setNumberFactory(NumberFactory.fractionNumber(denominator, exactDenom, wholeType));</span>

<span class="fc" id="L430">    }</span>

    private void setupFormatAsDecimal(final ConditionNumberFormatter formatter) {

<span class="fc" id="L434">        NumberPartType partType = NumberPartType.Integer;</span>
<span class="fc" id="L435">        boolean foundFirst = false;</span>
<span class="fc" id="L436">        int countDecimalTerm = 0;   // 小数部分の書式のカウント</span>
<span class="fc" id="L437">        boolean foundPercentTerm = false;</span>

<span class="fc bfc" id="L439" title="All 2 branches covered.">        for(Term&lt;FormattedNumber&gt; term : formatter.getTerms()) {</span>

<span class="fc bfc" id="L441" title="All 2 branches covered.">            if(isSymbolTerm(term, Token.SYMBOL_PERCENT)) {</span>
<span class="fc" id="L442">                foundPercentTerm = true;</span>

<span class="fc bfc" id="L444" title="All 2 branches covered.">            } else if(isSymbolTerm(term, Token.SYMBOL_DOT)) {</span>
<span class="fc" id="L445">                partType = NumberPartType.Decimal;</span>
<span class="fc" id="L446">                foundFirst = false;</span>

<span class="fc bfc" id="L448" title="All 2 branches covered.">            } else if(term instanceof NumberTerm.ExponentTerm) {</span>
<span class="fc" id="L449">                partType = NumberPartType.Exponent;</span>
<span class="fc" id="L450">                foundFirst = false;</span>

<span class="fc bfc" id="L452" title="All 2 branches covered.">            } else if(term instanceof NumberTerm.FormattedTerm) {</span>
<span class="fc" id="L453">                final NumberTerm.FormattedTerm formattedTerm = (NumberTerm.FormattedTerm) term;</span>
<span class="fc" id="L454">                formattedTerm.setPart(partType);</span>

<span class="fc bfc" id="L456" title="All 2 branches covered.">                if(partType.equals(NumberPartType.Decimal)) {</span>
                    // 小数部分の場合のインデックス番号を振る
<span class="fc" id="L458">                    countDecimalTerm++;</span>
<span class="fc" id="L459">                    formattedTerm.setIndex(countDecimalTerm);</span>

<span class="fc bfc" id="L461" title="All 2 branches covered.">                } else if(!foundFirst) {</span>
                    // 整数部分、指数部分の先頭の書式、最後の桁となる
<span class="fc" id="L463">                    formattedTerm.setLastPart(true);</span>
<span class="fc" id="L464">                    foundFirst = true;</span>
                }

            }
<span class="fc" id="L468">        }</span>

        // 最後から探索し、インデックス番号を振る
<span class="fc" id="L471">        foundFirst = false;</span>
<span class="fc" id="L472">        int countIntegerTerm = 0;</span>
<span class="fc" id="L473">        int countExponentTerm = 0;</span>

<span class="fc" id="L475">        final int termSize = formatter.getTerms().size();</span>
<span class="fc bfc" id="L476" title="All 2 branches covered.">        for(int i=0; i &lt; termSize; i++) {</span>
<span class="fc" id="L477">            final Term&lt;FormattedNumber&gt; term = formatter.getTerms().get(termSize-i-1);</span>

<span class="fc bfc" id="L479" title="All 2 branches covered.">            if(term instanceof NumberTerm.FormattedTerm) {</span>

<span class="fc" id="L481">                final NumberTerm.FormattedTerm formattedTerm = (NumberTerm.FormattedTerm) term;</span>

<span class="fc bfc" id="L483" title="All 2 branches covered.">                if(formattedTerm.getPartType().equals(NumberPartType.Decimal)) {</span>
                    // 小数部分の場合、はじめに見つかったものが、最後の桁
<span class="fc bfc" id="L485" title="All 2 branches covered.">                    if(!foundFirst) {</span>
<span class="fc" id="L486">                        formattedTerm.setLastPart(true);</span>
<span class="fc" id="L487">                        foundFirst = true;</span>
                    }

<span class="fc bfc" id="L490" title="All 2 branches covered.">                } else if(formattedTerm.getPartType().equals(NumberPartType.Integer)) {</span>
<span class="fc" id="L491">                    countIntegerTerm++;</span>
<span class="fc" id="L492">                    formattedTerm.setIndex(countIntegerTerm);</span>

<span class="pc bpc" id="L494" title="1 of 2 branches missed.">                } else if(formattedTerm.getPartType().equals(NumberPartType.Exponent)) {</span>
<span class="fc" id="L495">                    countExponentTerm++;</span>
<span class="fc" id="L496">                    formattedTerm.setIndex(countExponentTerm);</span>
                }

            }

        }

        // 桁区切りの判定処理
<span class="fc" id="L504">        boolean useSeparator = false;</span>
<span class="fc" id="L505">        boolean inIntegerPater = false;</span>
<span class="fc bfc" id="L506" title="All 2 branches covered.">        for(Term&lt;FormattedNumber&gt; term : formatter.getTerms()) {</span>
<span class="fc bfc" id="L507" title="All 2 branches covered.">            if(term instanceof NumberTerm.FormattedTerm) {</span>
<span class="fc" id="L508">                final NumberTerm.FormattedTerm formattedTerm = (NumberTerm.FormattedTerm) term;</span>
                // 整数の書式でかつ途中の書式の場合
<span class="fc bfc" id="L510" title="All 2 branches covered.">                if(formattedTerm.getPartType().equals(NumberPartType.Integer)) {</span>
<span class="fc bfc" id="L511" title="All 4 branches covered.">                    if(formattedTerm.isLastPart() &amp;&amp; formattedTerm.getIndex() &gt; 1) {</span>
<span class="fc" id="L512">                        inIntegerPater = true;</span>
<span class="fc bfc" id="L513" title="All 2 branches covered.">                    } else if(formattedTerm.getIndex() &lt;= 1) {</span>
<span class="fc" id="L514">                        inIntegerPater = false;</span>
                    }
                }
            }

<span class="fc bfc" id="L519" title="All 2 branches covered.">            if(term instanceof NumberTerm.SeparatorTerm) {</span>
<span class="fc bfc" id="L520" title="All 2 branches covered.">                if(inIntegerPater) {</span>
<span class="fc" id="L521">                    useSeparator = true;</span>
                }

            }
<span class="fc" id="L525">        }</span>

        // 最後の書式の直後の区切り文字の判定
<span class="fc" id="L528">        int indexLastFormatterdTerm = -1;</span>
<span class="fc bfc" id="L529" title="All 2 branches covered.">        for(int i=0; i &lt; termSize; i++) {</span>
<span class="fc" id="L530">            final Term&lt;FormattedNumber&gt; term = formatter.getTerms().get(termSize-i-1);</span>
<span class="fc bfc" id="L531" title="All 2 branches covered.">            if(term instanceof NumberTerm.FormattedTerm) {</span>
<span class="fc" id="L532">                indexLastFormatterdTerm = termSize-i-1;</span>
<span class="fc" id="L533">                break;</span>
            }
        }

<span class="fc" id="L537">        int countLastColon = 0;</span>
<span class="fc bfc" id="L538" title="All 4 branches covered.">        if(indexLastFormatterdTerm &gt;= 0 &amp;&amp; indexLastFormatterdTerm+1 &lt; termSize) {</span>
            // 最後の書式の直後の連続するカンマの個数をカウントする
<span class="fc bfc" id="L540" title="All 2 branches covered.">            for(int i=indexLastFormatterdTerm+1; i &lt; termSize; i++) {</span>
<span class="fc" id="L541">                final Term&lt;FormattedNumber&gt; term = formatter.getTerms().get(i);</span>
<span class="fc bfc" id="L542" title="All 2 branches covered.">                if(term instanceof NumberTerm.SeparatorTerm) {</span>
<span class="fc" id="L543">                    countLastColon++;</span>
                } else {
                    break;
                }
            }
        }

<span class="fc bfc" id="L550" title="All 2 branches covered.">        if(countExponentTerm &gt; 0) {</span>
            // 指数の場合
<span class="fc" id="L552">            formatter.setNumberFactory(NumberFactory.exponentNumber(countDecimalTerm, useSeparator));</span>

<span class="fc bfc" id="L554" title="All 2 branches covered.">        } else if(foundPercentTerm) {</span>
            // 百分率の場合
<span class="fc" id="L556">            formatter.setNumberFactory(NumberFactory.percentNumber(countDecimalTerm, useSeparator, countLastColon));</span>

        } else {
            // DBNnum指定でかつ、Generalの書式か判定する
<span class="fc" id="L560">            boolean useDBNum = false;</span>
<span class="fc bfc" id="L561" title="All 2 branches covered.">            for(String condition : formatter.getConditions()) {</span>
<span class="fc bfc" id="L562" title="All 2 branches covered.">                if(condition.startsWith(&quot;DBNum&quot;)) {</span>
<span class="fc" id="L563">                    useDBNum = true;</span>
<span class="fc" id="L564">                    break;</span>
                }
<span class="fc" id="L566">            }</span>

<span class="fc" id="L568">            boolean generalFormat = false;</span>
<span class="fc bfc" id="L569" title="All 2 branches covered.">            for(Term&lt;FormattedNumber&gt; term : formatter.getTerms()) {</span>
<span class="fc bfc" id="L570" title="All 2 branches covered.">                if(term instanceof NumberTerm.GeneralTerm) {</span>
<span class="fc" id="L571">                    generalFormat = true;</span>
<span class="fc" id="L572">                    break;</span>
                }
<span class="fc" id="L574">            }</span>

<span class="fc bfc" id="L576" title="All 4 branches covered.">            if(useDBNum &amp;&amp; generalFormat) {</span>
                // 漢数字かつ標準の数値の場合は、Nativeumberとして処理する。
<span class="fc" id="L578">                formatter.setNumberFactory(NumberFactory.nativeNumber());</span>
            } else {
<span class="fc" id="L580">                formatter.setNumberFactory(NumberFactory.decimalNumber(countDecimalTerm, useSeparator, countLastColon));</span>
            }

        }

<span class="fc" id="L585">    }</span>

    private static boolean isSymbolTerm(final Term&lt;FormattedNumber&gt; term, final Token.Symbol symbol) {

<span class="fc bfc" id="L589" title="All 2 branches covered.">        if(!(term instanceof NumberTerm.SymbolTerm)) {</span>
<span class="fc" id="L590">            return false;</span>
        }

<span class="fc" id="L593">        final NumberTerm.SymbolTerm symbolTerm = (NumberTerm.SymbolTerm) term;</span>
<span class="fc" id="L594">        return symbolTerm.getToken().equals(symbol);</span>

    }

    private static String[] toArray(final String[]... arrays) {
<span class="fc" id="L599">        List&lt;String&gt; list = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L600" title="All 2 branches covered.">        for(String[] array : arrays) {</span>
<span class="fc" id="L601">            list.addAll(Arrays.asList(array));</span>
        }

<span class="fc" id="L604">        return list.toArray(new String[list.size()]);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>