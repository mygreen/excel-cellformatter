<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ja"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JXLCell.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Excel-CellFormatter</a> &gt; <a href="index.source.html" class="el_package">com.github.mygreen.cellformatter</a> &gt; <span class="el_source">JXLCell.java</span></div><h1>JXLCell.java</h1><pre class="source lang-java linenums">package com.github.mygreen.cellformatter;

import java.util.Date;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.TimeUnit;

import com.github.mygreen.cellformatter.lang.ArgUtils;
import com.github.mygreen.cellformatter.lang.ExcelDateUtils;
import com.github.mygreen.cellformatter.lang.JXLUtils;
import com.github.mygreen.cellformatter.lang.Utils;

import jxl.BooleanCell;
import jxl.Cell;
import jxl.CellReferenceHelper;
import jxl.CellType;
import jxl.DateCell;
import jxl.LabelCell;
import jxl.NumberCell;
import jxl.biff.DisplayFormat;
import jxl.biff.XFRecord;
import jxl.format.CellFormat;
import jxl.format.Format;


/**
 * JExcel APIのラッパークラス。
 * 
 * @version 0.6
 * @since 0.4
 * @author T.TSUCHIE
 *
 */
public class JXLCell implements CommonCell {
    
    /** 日付の始まりが1904年開始かどうか */
    private final boolean dateStart1904;
    
    /**
     * 変換対象の組み込みフォーマット
     * ・間違っているものを対象とする。
     * ・環境によって変わるものは、FormattterResolverで変換する
     */
<span class="fc" id="L44">    private static Map&lt;Short, String&gt; BUILT_IN_FORMATS = new ConcurrentHashMap&lt;&gt;();</span>
    static {
        // 通貨（記号あり）
<span class="fc" id="L47">        BUILT_IN_FORMATS.put((short)5, &quot;$#,##0_);($#,##0)&quot;);</span>
<span class="fc" id="L48">        BUILT_IN_FORMATS.put((short)6, &quot;$#,##0_);[Red]($#,##0)&quot;);</span>
<span class="fc" id="L49">        BUILT_IN_FORMATS.put((short)7, &quot;$#,##0.00);($#,##0.00)&quot;);</span>
<span class="fc" id="L50">        BUILT_IN_FORMATS.put((short)8, &quot;$#,##0.00_);[Red]($#,##0.00)&quot;);</span>
        
        // 日付
<span class="fc" id="L53">        BUILT_IN_FORMATS.put((short)14, &quot;m/d/yy&quot;);</span>
        
        // 通貨（記号なし）
<span class="fc" id="L56">        BUILT_IN_FORMATS.put((short)37, &quot;#,##0_);(#,##0)&quot;);</span>
<span class="fc" id="L57">        BUILT_IN_FORMATS.put((short)38, &quot;#,##0_);[Red](#,##0)&quot;);</span>
<span class="fc" id="L58">        BUILT_IN_FORMATS.put((short)39, &quot;#,##0.00_);(#,##0.00)&quot;);</span>
<span class="fc" id="L59">        BUILT_IN_FORMATS.put((short)40, &quot;#,##0.00_);[Red](#,##0.00)&quot;);</span>
        
        // 会計（記号あり）
<span class="fc" id="L62">        BUILT_IN_FORMATS.put((short)41, &quot;_(* #,##0_);_(* (#,##0);_(* \&quot;-\&quot;_);_(@_)&quot;);</span>
<span class="fc" id="L63">        BUILT_IN_FORMATS.put((short)42, &quot;_($* #,##0_);_($* (#,##0);_($* \&quot;-\&quot;_);_(@_)&quot;);</span>
<span class="fc" id="L64">        BUILT_IN_FORMATS.put((short)43, &quot;_(* #,##0.00_);_(* (#,##0.00);_(* \&quot;-\&quot;??_);_(@_)&quot;);</span>
<span class="fc" id="L65">        BUILT_IN_FORMATS.put((short)44, &quot;_($* #,##0.00_);_($* (#,##0.00);_($* \&quot;-\&quot;??_);_(@_)&quot;);</span>
        
        // 経過時間
<span class="fc" id="L68">        BUILT_IN_FORMATS.put((short)46, &quot;[h]:mm:ss&quot;);</span>
<span class="fc" id="L69">    }</span>
    
    private final Cell cell;
    
    /**
     * セルを渡してインスタンスを作成する。
     * @param cell フォーマット対象のセルのインスタンス。
     * @param dateStart1904 日付の開始が1904年始まりかどうか。
     *        {@link JXLUtils#isDateStart1904(jxl.Sheet)}を使用して、Workbookまたはシートから取得する。
     * @throws IllegalArgumentException {@literal cell == null.}
     */
<span class="fc" id="L80">    public JXLCell(final Cell cell, final boolean dateStart1904) {</span>
<span class="fc" id="L81">        ArgUtils.notNull(cell, &quot;cell&quot;);</span>
<span class="fc" id="L82">        this.cell = cell;</span>
<span class="fc" id="L83">        this.dateStart1904 = dateStart1904;</span>
<span class="fc" id="L84">    }</span>
    
    /**
     * JExcelAPIの元々のセルのインスタンスを取得する。
     * @return
     */
    public Cell getCell() {
<span class="nc" id="L91">        return cell;</span>
    }
    
    @Override
    public short getFormatIndex() {
        // セルのスタイル情報の取得
<span class="fc" id="L97">        final CellFormat cellStyle = cell.getCellFormat();</span>
<span class="pc bpc" id="L98" title="1 of 2 branches missed.">        if(cellStyle == null) {</span>
<span class="nc" id="L99">            return 0;</span>
        }
        
<span class="fc" id="L102">        final short formatIndex = getFormatIndex(cellStyle);</span>
<span class="fc" id="L103">        return formatIndex;</span>
    }
    
    private short getFormatIndex(final CellFormat cellStyle) {
        
<span class="fc" id="L108">        final Format cellFormat = cellStyle.getFormat();</span>
<span class="pc bpc" id="L109" title="1 of 4 branches missed.">        if(cellFormat == null &amp;&amp; cellStyle instanceof XFRecord) {</span>
<span class="fc" id="L110">            final XFRecord record = (XFRecord) cellStyle;</span>
<span class="fc" id="L111">            return (short) record.formatIndex;</span>
            
<span class="pc bpc" id="L113" title="1 of 2 branches missed.">        } else if(cellFormat == null) {</span>
<span class="nc" id="L114">            return 0;</span>
        }
        
<span class="pc bpc" id="L117" title="1 of 2 branches missed.">        if(cellFormat instanceof DisplayFormat) {</span>
<span class="fc" id="L118">            final DisplayFormat displayFormat = (DisplayFormat)cellFormat;</span>
<span class="fc" id="L119">            return (short) displayFormat.getFormatIndex();</span>
        }
        
<span class="nc" id="L122">        return 0;</span>
        
    }
    
    @Override
    public String getFormatPattern() {
        
        // セルのスタイル情報の取得
<span class="fc" id="L130">        final CellFormat cellStyle = cell.getCellFormat();</span>
<span class="pc bpc" id="L131" title="1 of 2 branches missed.">        if(cellStyle == null) {</span>
<span class="nc" id="L132">            return &quot;&quot;;</span>
        }
        
        // 変換対象のビルトインフォーマットの場合
<span class="fc" id="L136">        final short formatIndex = getFormatIndex(cellStyle);</span>
<span class="fc bfc" id="L137" title="All 2 branches covered.">        if(BUILT_IN_FORMATS.containsKey(formatIndex)) {</span>
<span class="fc" id="L138">            return BUILT_IN_FORMATS.get(formatIndex);</span>
        }
        
        // セルのフォーマットの取得
<span class="fc" id="L142">        final Format cellFormat = cellStyle.getFormat();</span>
<span class="fc bfc" id="L143" title="All 2 branches covered.">        if(cellFormat == null) {</span>
<span class="fc" id="L144">            return &quot;&quot;;</span>
        }
        
<span class="fc" id="L147">        final String formatPattern = cellFormat.getFormatString();</span>
<span class="fc bfc" id="L148" title="All 2 branches covered.">        if(Utils.isEmpty(formatPattern)) {</span>
<span class="fc" id="L149">            return &quot;&quot;;</span>
        }
        
<span class="fc" id="L152">        return formatPattern;</span>
    }
    
    @Override
    public boolean isText() {
<span class="fc bfc" id="L157" title="All 4 branches covered.">        return cell.getType() == CellType.LABEL || cell.getType() == CellType.STRING_FORMULA;</span>
    }
    
    @Override
    public String getTextCellValue() {
        
<span class="fc" id="L163">        final CellType type = cell.getType();</span>
<span class="pc bpc" id="L164" title="1 of 4 branches missed.">        if(type == CellType.LABEL || type == CellType.STRING_FORMULA) {</span>
<span class="fc" id="L165">            return ((LabelCell) cell).getString();</span>
            
        } else {
<span class="nc" id="L168">            return cell.getContents();</span>
        }
        
    }
    
    @Override
    public boolean isBoolean() {
<span class="fc bfc" id="L175" title="All 4 branches covered.">        return cell.getType() == CellType.BOOLEAN || cell.getType() == CellType.BOOLEAN_FORMULA;</span>
    }
    
    @Override
    public boolean getBooleanCellValue() {
        
<span class="fc" id="L181">        final CellType type = cell.getType();</span>
<span class="pc bpc" id="L182" title="1 of 4 branches missed.">        if(type == CellType.BOOLEAN || type == CellType.BOOLEAN_FORMULA) {</span>
<span class="fc" id="L183">            return ((BooleanCell) cell).getValue();</span>
            
        } else {
<span class="nc" id="L186">            return false;</span>
        }
        
    }
    
    @Override
    public boolean isNumber() {
<span class="fc" id="L193">        final CellType type = cell.getType();</span>
<span class="fc bfc" id="L194" title="All 8 branches covered.">        return type == CellType.NUMBER || type == CellType.NUMBER_FORMULA</span>
                || type == CellType.DATE || type == CellType.DATE_FORMULA;
    }
    
    @Override
    public double getNumberCellValue() {
        
<span class="fc" id="L201">        final CellType type = cell.getType();</span>
<span class="pc bpc" id="L202" title="1 of 4 branches missed.">        if(type == CellType.NUMBER || type == CellType.NUMBER_FORMULA) {</span>
<span class="fc" id="L203">            return ((NumberCell) cell).getValue();</span>
            
<span class="nc bnc" id="L205" title="All 4 branches missed.">        } else if(type == CellType.DATE || type == CellType.DATE_FORMULA) {</span>
<span class="nc" id="L206">            final Date  date = ((DateCell) cell).getDate();</span>
<span class="nc" id="L207">            final double num = ExcelDateUtils.convertExcelNumber(date, isDateStart1904());</span>
<span class="nc" id="L208">            return num;</span>
            
        } else {
<span class="nc" id="L211">            return 0;</span>
        }
    }
    
    @Override
    public Date getDateCellValue() {
        
<span class="fc bfc" id="L218" title="All 4 branches covered.">        if(cell.getType() == CellType.DATE || cell.getType() == CellType.DATE_FORMULA) {</span>
<span class="fc" id="L219">            Date date = ((DateCell) cell).getDate();</span>
<span class="fc" id="L220">            return adjustDate(date);</span>
            
<span class="pc bpc" id="L222" title="3 of 4 branches missed.">        } else if(cell.getType() == CellType.NUMBER || cell.getType() == CellType.NUMBER_FORMULA) {</span>
<span class="fc" id="L223">            final double num = getNumberCellValue();</span>
<span class="fc" id="L224">            final Date date = ExcelDateUtils.convertJavaDate(num, isDateStart1904());</span>
<span class="fc" id="L225">            return date;</span>
            
        } else {
<span class="nc" id="L228">            return new Date(ExcelDateUtils.getExcelZeroDateTime(isDateStart1904()));</span>
        }
    }
    
    /**
     * 時刻の調整を行う。
     * &lt;p&gt;1900年1月0日が、1899-12-30となり、1899年12月31日以降が1日ずれるため、調整を行う。
     * @param date
     * @return
     */
    private Date adjustDate(final Date date) {
        
<span class="fc bfc" id="L240" title="All 4 branches covered.">        if(!isDateStart1904() &amp;&amp; date.getTime() &lt; ExcelDateUtils.MILLISECONDS_19000101) {</span>
<span class="fc" id="L241">            return new Date(date.getTime() + TimeUnit.DAYS.toMillis(1));</span>
        }
        
<span class="fc" id="L244">        return date;</span>
    }
    
    @Override
    public boolean isDateStart1904() {
        // JExcelAPIの場合は、Workbookからでないと取得できないため、コンストラクタで渡す。
<span class="fc" id="L250">        return dateStart1904;</span>
    }
    
    @Override
    public String getCellAddress() {
<span class="nc" id="L255">        return CellReferenceHelper.getCellReference(cell.getColumn(), cell.getRow());</span>
    }
    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>