<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ja"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SimpleFraction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Excel-CellFormatter</a> &gt; <a href="index.source.html" class="el_package">com.github.mygreen.cellformatter.number</a> &gt; <span class="el_source">SimpleFraction.java</span></div><h1>SimpleFraction.java</h1><pre class="source lang-java linenums">package com.github.mygreen.cellformatter.number;

/**
 * 簡易的な分数を表現するクラス。
 * &lt;p&gt;古いPOIだと提供されていないため、同じものを実装。&lt;/p&gt;
 *
 * @author T.TSUCHIE
 *
 */
public class SimpleFraction {
    
    /** 分母 */
    private final int denominator;
    
    /** 分子 */
    private final int numerator;
    
    /**
     * 分子と分母を指定してインスタンスを作成する。
     * @param numerator 分子。
     * @param denominator 分母。
     */
<span class="fc" id="L23">    public SimpleFraction(final int numerator, final int denominator) {</span>
<span class="pc bpc" id="L24" title="1 of 2 branches missed.">        if(denominator == 0) {</span>
<span class="nc" id="L25">            throw new IllegalArgumentException(&quot;denominator should not be zero.&quot;);</span>
        }
        
<span class="fc" id="L28">        this.numerator = numerator;</span>
<span class="fc" id="L29">        this.denominator = denominator;</span>
<span class="fc" id="L30">    }</span>
    
    /**
     * 分母の値を指定してインスタンスを作成する。
     * 
     * @param val 分数として表現するもとの数値の値。
     * @param exactDenom 分母の値。
     * @return 
     */
    public static SimpleFraction createFractionExactDenominator(final double val, final int exactDenom){
<span class="fc" id="L40">        int num =  (int)Math.round(val*(double)exactDenom);</span>
<span class="fc" id="L41">        return new SimpleFraction(num,exactDenom);</span>
    }
    
    /**
     * 分母の最大値を指定してインスタンスを作成する。
     * &lt;p&gt;指定した分母の値以下に近似した分数を取得する。
     * 
     * @param value 分数として表現するもとの数値の値。
     * @param maxDenominator 分母の最大値。
     * 
     * @throws RuntimeException if the continued fraction failed to converge.
     * @throws IllegalArgumentException {@literal if value &gt; Integer.MAX_VALUE}
     */
    public static SimpleFraction createFractionMaxDenominator(final double value, final int maxDenominator){
<span class="fc" id="L55">        return buildFractionMaxDenominator(value, 0, maxDenominator, 100);</span>
    }
    /**
     * Create a fraction given the double value and either the maximum error
     * allowed or the maximum number of denominator digits.
     * &lt;p&gt;
     * References:
     * &lt;ul&gt;
     * &lt;li&gt;&lt;a href=&quot;http://mathworld.wolfram.com/ContinuedFraction.html&quot;&gt;
     * Continued Fraction&lt;/a&gt; equations (11) and (22)-(26)&lt;/li&gt;
     * &lt;/ul&gt;
     * &lt;/p&gt;
     *
     *  Based on org.apache.commons.math.fraction.Fraction from Apache Commons-Math.
     *  YK: The only reason of having this class is to avoid dependency on the Commons-Math jar.
     *
     * @param value the double value to convert to a fraction.
     * @param epsilon maximum error allowed.  The resulting fraction is within
     *        &lt;code&gt;epsilon&lt;/code&gt; of &lt;code&gt;value&lt;/code&gt;, in absolute terms.
     * @param maxDenominator maximum denominator value allowed.
     * @param maxIterations maximum number of convergents
     * @throws RuntimeException if the continued fraction failed to
     *         converge.
     * @throws IllegalArgumentException if value &gt; Integer.MAX_VALUE
     */
    private static SimpleFraction buildFractionMaxDenominator(final double value, final double epsilon,
            final int maxDenominator, final int maxIterations) {
        
<span class="fc" id="L83">        final long overflow = Integer.MAX_VALUE;</span>
<span class="fc" id="L84">        double r0 = value;</span>
<span class="fc" id="L85">        long a0 = (long)Math.floor(r0);</span>
<span class="pc bpc" id="L86" title="1 of 2 branches missed.">        if (a0 &gt; overflow) {</span>
<span class="nc" id="L87">            throw new IllegalArgumentException(&quot;Overflow trying to convert &quot;+value+&quot; to fraction (&quot;+a0+&quot;/&quot;+1l+&quot;)&quot;);</span>
        }
        
        // check for (almost) integer arguments, which should not go
        // to iterations.
<span class="pc bpc" id="L92" title="1 of 2 branches missed.">        if (Math.abs(a0 - value) &lt; epsilon) {</span>
<span class="nc" id="L93">            return new SimpleFraction((int)a0, 1);</span>
        }

<span class="fc" id="L96">        long p0 = 1;</span>
<span class="fc" id="L97">        long q0 = 0;</span>
<span class="fc" id="L98">        long p1 = a0;</span>
<span class="fc" id="L99">        long q1 = 1;</span>

        long p2;
        long q2;

<span class="fc" id="L104">        int n = 0;</span>
<span class="fc" id="L105">        boolean stop = false;</span>
        do {
<span class="fc" id="L107">            ++n;</span>
<span class="fc" id="L108">            double r1 = 1.0 / (r0 - a0);</span>
<span class="fc" id="L109">            long a1 = (long)Math.floor(r1);</span>
<span class="fc" id="L110">            p2 = (a1 * p1) + p0;</span>
<span class="fc" id="L111">            q2 = (a1 * q1) + q0;</span>
            //MATH-996/POI-55419
<span class="pc bpc" id="L113" title="3 of 8 branches missed.">            if (epsilon == 0.0f &amp;&amp; maxDenominator &gt; 0 &amp;&amp; Math.abs(q2) &gt; maxDenominator &amp;&amp;</span>
                    Math.abs(q1) &lt; maxDenominator){

<span class="fc" id="L116">                return new SimpleFraction((int)p1, (int)q1);</span>
            }
<span class="pc bpc" id="L118" title="2 of 4 branches missed.">            if ((p2 &gt; overflow) || (q2 &gt; overflow)) {</span>
<span class="nc" id="L119">                throw new RuntimeException(&quot;Overflow trying to convert &quot;+value+&quot; to fraction (&quot;+p2+&quot;/&quot;+q2+&quot;)&quot;);</span>
            }

<span class="fc" id="L122">            double convergent = (double)p2 / (double)q2;</span>
<span class="pc bpc" id="L123" title="2 of 6 branches missed.">            if (n &lt; maxIterations &amp;&amp; Math.abs(convergent - value) &gt; epsilon &amp;&amp; q2 &lt; maxDenominator) {</span>
<span class="fc" id="L124">                p0 = p1;</span>
<span class="fc" id="L125">                p1 = p2;</span>
<span class="fc" id="L126">                q0 = q1;</span>
<span class="fc" id="L127">                q1 = q2;</span>
<span class="fc" id="L128">                a0 = a1;</span>
<span class="fc" id="L129">                r0 = r1;</span>
            } else {
<span class="fc" id="L131">                stop = true;</span>
            }
<span class="fc bfc" id="L133" title="All 2 branches covered.">        } while (!stop);</span>

<span class="pc bpc" id="L135" title="1 of 2 branches missed.">        if (n &gt;= maxIterations) {</span>
<span class="nc" id="L136">            throw new RuntimeException(&quot;Unable to convert &quot;+value+&quot; to fraction after &quot;+maxIterations+&quot; iterations&quot;);</span>
        }

<span class="pc bpc" id="L139" title="1 of 2 branches missed.">        if (q2 &lt; maxDenominator) {</span>
<span class="fc" id="L140">            return new SimpleFraction((int) p2, (int)q2);</span>
        } else {
<span class="nc" id="L142">            return new SimpleFraction((int)p1, (int)q1);</span>
        }

    }
    
    /**
     * 分母の取得
     * 
     * @return the denominator.
     */
    public int getDenominator() {
<span class="fc" id="L153">        return denominator;</span>
    }
    
    /**
     * 分子の取得
     * 
     * @return the numerator.
     */
    public int getNumerator() {
<span class="fc" id="L162">        return numerator;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>