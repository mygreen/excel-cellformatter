<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ja"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ExcelDateUtils.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Excel-CellFormatter</a> &gt; <a href="index.source.html" class="el_package">com.github.mygreen.cellformatter.lang</a> &gt; <span class="el_source">ExcelDateUtils.java</span></div><h1>ExcelDateUtils.java</h1><pre class="source lang-java linenums">package com.github.mygreen.cellformatter.lang;

import java.math.BigDecimal;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.TimeZone;
import java.util.concurrent.TimeUnit;

/**
 * Excelの日時表現を処理するためのユーティリティクラス。
 * &lt;ul&gt;
 *  &lt;li&gt;Excel上は、1900年は閏年扱いで、1900年2月29日が存在する。&lt;/li&gt;
 *  &lt;li&gt;Javaの形式に変換したときは、1900年3月1日扱いとする。&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * @since 0.6
 * @author T.TSUCHIE
 *
 */
<span class="nc" id="L21">public class ExcelDateUtils {</span>
    
    /**
     * 24時間の秒数。
     */
<span class="fc" id="L26">    public static final int SECONDS_IN_DAYS = (int) TimeUnit.HOURS.toSeconds(24);</span>
    
    /**
     * {@literal 1900-01-01 00:00:00.000}の時間（単位はミリ秒）。
     * &lt;p&gt;Excelは設定により、1900年始まりか1904年始まりか指定できるため、その基準値として利用する。
     */
<span class="fc" id="L32">    public static final long MILLISECONDS_19000101 = parseDate(&quot;1900-01-01 00:00:00.000&quot;).getTime();</span>
    
    /**
     * {@literal 1904-01-01 00:00:00.000}の時間（単位はミリ秒）。
     * &lt;p&gt;Excelは設定により、1900年始まりか1904年始まりか指定できるため、その基準値として利用する。
     */
<span class="fc" id="L38">    public static final long MILLISECONDS_19040101 = parseDate(&quot;1904-01-01 00:00:00.000&quot;).getTime();</span>
    
    /**
     * 1900-03-01の時間（単位はミリ秒）。
     * &lt;p&gt;Excelは1900年始まりの場合、閏日でない1900年2月29日（=3月1日）が存在するため、その基準値として利用する。
     */
<span class="fc" id="L44">    public static final long MILLISECONDS_19000301 = ExcelDateUtils.parseDate(&quot;1900-03-01 00:00:00.000&quot;).getTime();</span>
    
    /**
     * Javaの基準日(=0)である1970年1月1日に対するExcelの基準日1900年1月0日の日のオフセット（単位は日）。
     * &lt;p&gt;ただし、Excelは1900年は1月0日から始まり、実質1899年12月31日となる。
     */
    public static final int OFFSET_DAYS_1900; 
    
    /**
     * Javaの基準日(=0)である1970年1月1日に対するExcelの基準日1904年1月1日の日のオフセット（単位は日）。
     */
    public static final int OFFSET_DAYS_1904;
    
    static {
<span class="fc" id="L58">        long offsetDay1900 = parseDate(&quot;1900-01-01 00:00:00.000&quot;).getTime() / ((long)SECONDS_IN_DAYS * 1000);</span>
<span class="fc" id="L59">        OFFSET_DAYS_1900 = (int) offsetDay1900 -1;</span>
        
<span class="fc" id="L61">        long offsetDay1904 = parseDate(&quot;1904-01-01 00:00:00.000&quot;).getTime() / ((long)SECONDS_IN_DAYS * 1000);</span>
<span class="fc" id="L62">        OFFSET_DAYS_1904 = (int) offsetDay1904;</span>
<span class="fc" id="L63">    }</span>
    
    /**
     * 1900年開始の場合、3月1日の経過日数。
     * &lt;p&gt;1900年は閏年ではないが、Excelの場合は閏年扱いのため、
     *    1900年1月～2月の期間（60日23時59分59秒=60.9999）を表現するための定数として利用する。
     */
    public static final int NON_LEAP_DAY = 61;
    
    /**
     * Excel表現上の数値をJavaの{@link Date}型(UTC形式)に変換する。
     * &lt;p&gt;1900年始まりの場合は以下の注意が必要。&lt;/p&gt;
     * &lt;ul&gt;
     *   &lt;li&gt;値{@literal 0.0}は、Excel上は1900年1月0日であるが、Date型へ変換した場合は1899年12月31日となります。&lt;/li&gt;
     *   &lt;li&gt;値{@literal 60.0}は、Excel上は1900年2月29日だが、グレゴリオ歴上は閏日ではあにため、1900年3月1日となります。&lt;/li&gt;
     * &lt;/ul&gt;
     * 
     * @param numValue 変換対象のExcel表現上の数値。
     * @param startDate1904 基準日が1904年始まりかどうか。
     * @return Java表現上に変換した日時。
     *         ただし、この値はタイムゾーンは考慮されていない（=GMT-00:00）ため、
     *         変換後は独自に処理を行う必要があります。
     */
    public static Date convertJavaDate(final double numValue, final boolean startDate1904) {
        
        double utcDay;
<span class="fc bfc" id="L89" title="All 2 branches covered.">        if(startDate1904) {</span>
            // 1904年始まりの場合
            
            // UTC(1970年基準に戻す)
<span class="fc" id="L93">            utcDay = numValue + OFFSET_DAYS_1904;</span>
            
        } else {
            // 1900年始まりの場合
            
            // UTC(1970年基準に戻す)
<span class="fc" id="L99">            utcDay = numValue + OFFSET_DAYS_1900;</span>
            
            /*
             * 1900年3月1日（Excel上は1900年2月29日）以降の場合の補正。
             * ・Excel上は1900年は、閏年扱いで1900年2月29日の閏年が存在する。
             * ・しかし、グレゴリオ歴上は1900年は閏年ではないため、UTCの表現上から見ると1日多い。
             * ・1900年2月29日は、1900年1月0日から数えて61日目なので、61日以降は、1日前に戻す。
             */
<span class="fc bfc" id="L107" title="All 2 branches covered.">            if(numValue &gt;= NON_LEAP_DAY) {</span>
<span class="fc" id="L108">                utcDay -= 1;</span>
            }
            
        }
        
        /*
         * Javaのミリ秒に直す。
         * ・Excelの日付の形式の場合小数部が時間を示すため、24時間分のミリ秒を考慮する。
         */
<span class="fc" id="L117">        long utcTime = Math.round(utcDay * SECONDS_IN_DAYS) * 1000;</span>
<span class="fc" id="L118">        return new Date(utcTime);</span>
        
    }
    
    /**
     * Javaの{@link Date}型をExcelの内部表現の数値に変換する。
     * &lt;p&gt;小数の桁数に関する注意事項。&lt;/p&gt;
     * &lt;ul&gt;
     *    &lt;li&gt;このメソッドは少数は第16位まで保証し、小数第17位は四捨五入して計算します。&lt;/li&gt;
     *    &lt;li&gt;Excelの1秒は、UTC上では1/(60x60x24x1000)=0.0000000115741=1.15741e-008であるので、小数13位までの精度が必要。&lt;/li&gt;
     *    &lt;li&gt;Excelは秒までだが、Javaはミリ秒まで存在するので、さらに3桁多い、16桁までの精度が必要になる。&lt;/li&gt;
     * &lt;/ul&gt;
     * 
     * &lt;p&gt;1900年始まりの場合は以下の注意が必要。&lt;/p&gt;
     * &lt;ul&gt;
     *   &lt;li&gt;UTC上は1900年2月29日は存在しないため、{@literal 60.0}への変換はできません。&lt;/li&gt;
     * &lt;/ul&gt;
     * 
     * @param value 変換対象のJava表現上の日時。タイムゾーンを排除した（GMT-00:00）日時。
     * @param startDate1904 基準日が1904年始まりかどうか。
     * @return Excel表現上に変換した数値。
     * @throws IllegalArgumentException {@literal value == nulll.}
     */
    public static double convertExcelNumber(final Date value, final boolean startDate1904) {
        
<span class="fc" id="L143">        ArgUtils.notNull(value, &quot;value&quot;);</span>
        
        /*
         * Excelの時間の表現に直す。
         * ・Excelの日付の形式の場合小数部が時間を示すため、24時間分のミリ秒を考慮する。
         */
<span class="fc" id="L149">        long utcDay = value.getTime();</span>
<span class="fc" id="L150">        BigDecimal numValue = new BigDecimal(utcDay);</span>
<span class="fc" id="L151">        numValue = numValue.divide(new BigDecimal(SECONDS_IN_DAYS * 1000), 17, BigDecimal.ROUND_HALF_UP);</span>
        
<span class="fc bfc" id="L153" title="All 2 branches covered.">        if(startDate1904) {</span>
            // 1904年始まりの場合
<span class="fc" id="L155">            numValue = numValue.subtract(new BigDecimal(OFFSET_DAYS_1904));</span>
            
        } else {
            // 1900年始まりの場合
<span class="fc" id="L159">            numValue = numValue.subtract(new BigDecimal(OFFSET_DAYS_1900));</span>
            
<span class="fc bfc" id="L161" title="All 2 branches covered.">            if(numValue.compareTo(new BigDecimal(NON_LEAP_DAY - 1)) &gt;= 0) {</span>
<span class="fc" id="L162">                numValue = numValue.add(new BigDecimal(1));</span>
            }
            
        }
        
<span class="fc" id="L167">        return numValue.doubleValue();</span>
        
    }
    
    /**
     * 日時形式を{@literal yyyy-MM-dd HH:mm:ss.SSS}の書式でフォーマットする。
     * &lt;p&gt;ただし、タイムゾーンは、標準時間の{@literal GMT-00:00}で処理する。
     * @param date フォーマット対象の日時。
     * @return フォーマットした文字列。
     * @throws IllegalArgumentException date is null.
     */
    public static String formatDate(final Date date) {
        
<span class="fc" id="L180">        ArgUtils.notNull(date, &quot;date&quot;);</span>
        
<span class="fc" id="L182">        SimpleDateFormat format = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;);</span>
<span class="fc" id="L183">        format.setTimeZone(TimeZone.getTimeZone(&quot;GMT-00:00&quot;));</span>
<span class="fc" id="L184">        return format.format(date);</span>
        
    }
    
    /**
     * 文字列を日時形式を{@literal yyyy-MM-dd HH:mm:ss.SSS}のパースする。
     * &lt;p&gt;ただし、タイムゾーンは、標準時間の{@literal GMT-00:00}で処理する。
     * @param str パース対象の文字列
     * @return パースした日付。
     * @throws IllegalArgumentException str is empty.
     * @throws IllegalStateException fail parsing.
     */
    public static Date parseDate(final String str) {
<span class="fc" id="L197">        ArgUtils.notEmpty(str, str);</span>
        
        try {
<span class="fc" id="L200">            SimpleDateFormat format = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;);</span>
<span class="fc" id="L201">            format.setTimeZone(TimeZone.getTimeZone(&quot;GMT-00:00&quot;));</span>
<span class="fc" id="L202">            return format.parse(str);</span>
<span class="nc" id="L203">        } catch (ParseException e) {</span>
<span class="nc" id="L204">            throw new IllegalStateException(String.format(&quot;fail parse to Data from '%s',&quot;, str), e);</span>
        }
        
    }
    
    /**
     * Excelの日付となる（=数値では0の値）の時の、時間の取得。（単位はミリ秒）。
     * &lt;p&gt;1900年始まりの場合、Excelでは1月0日から始まるため、{@literal 1899-12-31 00:00:00.000}の値を返す。
     * &lt;p&gt;1904年始まりは、{@literal 1904-01-01 0:00:00}の値を返す。
     * &lt;p&gt;引数により、1904年始まりの場合の値か選択できる。
     * @param isStartDate1904 1904年始まりかどうか。
     * @return Excelの基準日に対するUTC表現上のミリ秒。
     */
    public static long getExcelZeroDateTime(boolean isStartDate1904) {
<span class="fc bfc" id="L218" title="All 2 branches covered.">        if(isStartDate1904) {</span>
<span class="fc" id="L219">            return MILLISECONDS_19040101;</span>
        } else {
<span class="fc" id="L221">            return MILLISECONDS_19000101 - TimeUnit.DAYS.toMillis(1);</span>
        }
    }
    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>